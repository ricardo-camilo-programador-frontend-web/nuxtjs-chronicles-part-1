name: SonarQube

concurrency:
  group: nuxtjs-chronicles-part-1-selfhosted
  cancel-in-progress: false

on:
  push:
    branches: [ master, develop ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Hard reset git auth (self-hosted safety)
        run: |
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global --unset-all credential.helper || true
          git config --global --unset-all core.sshCommand || true

      - name: Checkout repository (SSH only)
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.GH_SSH_KEY }}
          persist-credentials: false
          fetch-depth: 0

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_ENABLE_PR_DECORATION: "false"
        run: |
          set -e

          if [ -z "$SONAR_TOKEN" ] || [ -z "$SONAR_HOST_URL" ]; then
            echo "::error::SONAR_TOKEN and SONAR_HOST_URL must be set as GitHub Secrets"
            exit 1
          fi

          echo "Testing SonarQube connectivity..."
          curl -f -s "$SONAR_HOST_URL/api/system/status" >/dev/null

          echo "Running SonarQube scan..."

          docker run --rm \
            --network=host \
            -v "$PWD:/usr/src" \
            -w /usr/src \
            -e SONAR_TOKEN="$SONAR_TOKEN" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.token="$SONAR_TOKEN" \
            -Dsonar.host.url="$SONAR_HOST_URL"

          echo "SONAR_DASHBOARD_URL=$SONAR_HOST_URL/dashboard?id=nuxtjs-chronicles-part-1" >> $GITHUB_ENV

      - name: Comment PR with SonarQube Dashboard Link
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- sonarqube-analysis -->
            ## ðŸ“Š SonarQube Analysis

            **ðŸ”— [Abrir dashboard](${{ env.SONAR_DASHBOARD_URL }})**

            **Projeto:** `nuxtjs-chronicles-part-1`  
            **Branch:** `${{ github.head_ref }}`  
            **Commit:** `${{ github.sha }}`

            ---
            _Executado via runner self-hosted_
